<script lang="ts">
  import { apiKeyStore } from "$lib/stores/api";
  import { buildPersonalWebsitePrompt } from "@prompt-hub/prompt";
  import { useAIStream } from "$lib/hooks/useAIStream";

  // è¡¨å•æ•°æ®
  let formData = {
    name: "",
    profession: "",
    skills: "",
    background: "",
    contactType: "email" as "email" | "wechat" | "github",
    contactValue: ""
  };
  
  let githubToken = "";
  let gistUrl = "";
  let isDeploying = false;
  let viewMode: "preview" | "code" = "preview"; // è§†å›¾æ¨¡å¼ï¼šé¢„è§ˆæˆ–ä»£ç 

  $: aiStream = useAIStream("personal-website");
  $: state = aiStream.state;
  $: ({ progress, status, result, error } = $state);
  $: statusTip = aiStream.statusTip;
  $: loading = status !== "done" && status !== "error" && status !== "idle";
  
  // æå–HTMLä»£ç ï¼ˆå»é™¤å¯èƒ½çš„markdownä»£ç å—æ ‡è®°ï¼‰
  $: htmlCode = result ? extractHtmlCode(result) : "";
  $: hasResult = htmlCode.length > 0;

  // æå–HTMLä»£ç çš„è¾…åŠ©å‡½æ•°
  function extractHtmlCode(text: string): string {
    // ç§»é™¤markdownä»£ç å—æ ‡è®°
    const codeBlockRegex = /```html\s*([\s\S]*?)\s*```/;
    const match = text.match(codeBlockRegex);
    if (match) {
      return match[1].trim();
    }
    
    // å¦‚æœæ²¡æœ‰ä»£ç å—æ ‡è®°ï¼Œæ£€æŸ¥æ˜¯å¦ç›´æ¥æ˜¯HTML
    if (text.includes("<!DOCTYPE") || text.includes("<html")) {
      return text.trim();
    }
    
    return text;
  }

  // æ„å»ºè‡ªæˆ‘ä»‹ç»æ–‡æœ¬
  function buildIntroduction(): string {
    let intro = "";

    // åŸºæœ¬ä¿¡æ¯
    if (formData.name || formData.profession) {
      intro += `## åŸºæœ¬ä¿¡æ¯\n`;
      if (formData.name) intro += `å§“åï¼š${formData.name}\n`;
      if (formData.profession) intro += `èŒä¸šï¼š${formData.profession}\n`;
      intro += `\n`;
    }

    // æŠ€èƒ½å’Œçˆ±å¥½
    if (formData.skills.trim()) {
      intro += `## æŠ€èƒ½å’Œçˆ±å¥½\n${formData.skills}\n\n`;
    }

    // èƒŒæ™¯ç»å†
    if (formData.background.trim()) {
      intro += `## æ•™è‚²èƒŒæ™¯/å·¥ä½œç»å†\n${formData.background}\n\n`;
    }

    // è”ç³»æ–¹å¼
    const contacts = [];
    if (formData.contactValue) {
      const typeMap = {
        email: "é‚®ç®±",
        wechat: "å¾®ä¿¡",
        github: "GitHub"
      };
      contacts.push(`${typeMap[formData.contactType]}ï¼š${formData.contactValue}`);
    }
    
    if (contacts.length > 0) {
      intro += `## è”ç³»æ–¹å¼\n${contacts.join("\n")}\n`;
    }

    return intro;
  }

  // ç”Ÿæˆä¸ªäººç½‘ç«™
  async function generateWebsite() {
    if (!$apiKeyStore) return;
    
    // éªŒè¯å¿…å¡«é¡¹
    if (!formData.name.trim() || !formData.profession.trim()) {
      alert("è¯·è‡³å°‘å¡«å†™å§“åå’ŒèŒä¸š");
      return;
    }

    const introduction = buildIntroduction();
    const prompt = buildPersonalWebsitePrompt() + "\n\n" + introduction;
    await aiStream.invoke(prompt);
  }

  // ä¸‹è½½HTMLæ–‡ä»¶
  function downloadHTML() {
    if (!htmlCode) return;

    const blob = new Blob([htmlCode], { type: "text/html;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "personal-website.html";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // éƒ¨ç½²åˆ°GitHub Gist
  async function deployToGist() {
    if (!htmlCode || !githubToken.trim()) {
      alert("è¯·å…ˆç”Ÿæˆç½‘ç«™å¹¶é…ç½® GitHub Token");
      return;
    }

    isDeploying = true;
    gistUrl = "";

    const gistData = {
      description: "Personal Website - Generated by Prompt Hub",
      public: true,
      files: {
        "index.html": {
          content: htmlCode,
        },
      },
    };

    const response = await fetch("https://api.github.com/gists", {
      method: "POST",
      headers: {
        Authorization: `token ${githubToken}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(gistData),
    });

    if (response.ok) {
      const data = await response.json();
      // ä½¿ç”¨ htmlpreview.github.io æ¥é¢„è§ˆ Gist ä¸­çš„ HTML
      const rawUrl = data.files["index.html"].raw_url;
      gistUrl = `https://htmlpreview.github.io/?${rawUrl}`;
      alert("éƒ¨ç½²æˆåŠŸï¼å·²ç”Ÿæˆå¯è®¿é—®é“¾æ¥");
    } else {
      const errorData = await response.json();
      alert(`éƒ¨ç½²å¤±è´¥ï¼š${errorData.message || "æœªçŸ¥é”™è¯¯"}`);
    }

    isDeploying = false;
  }

  // é‡ç½®
  function resetAll() {
    formData = {
      name: "",
      profession: "",
      skills: "",
      background: "",
      contactType: "email",
      contactValue: ""
    };
    githubToken = "";
    gistUrl = "";
    aiStream.reset();
  }

  // å…¨å±æ˜¾ç¤º
  let previewContainer: HTMLElement;
  let isFullscreen = false;
  
  function toggleFullscreen() {
    if (!previewContainer) return;
    
    if (!document.fullscreenElement) {
      previewContainer.requestFullscreen();
    } else {
      document.exitFullscreen();
    }
  }

  // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–
  if (typeof window !== 'undefined') {
    document.addEventListener('fullscreenchange', () => {
      isFullscreen = !!document.fullscreenElement;
    });
  }

  // åœ¨æ–°çª—å£æ‰“å¼€
  function openInNewWindow() {
    if (!htmlCode) return;
    
    const blob = new Blob([htmlCode], { type: "text/html;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    window.open(url, "_blank", "width=1200,height=800");
    
    // å»¶è¿Ÿé‡Šæ”¾ URLï¼Œç¡®ä¿æ–°çª—å£å·²åŠ è½½
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }
</script>

<svelte:head>
  <title>ä¸ªäººç½‘ç«™ç”Ÿæˆå™¨ - Prompt Hub</title>
  <meta name="description" content="å¡«å†™è¡¨å•ä¿¡æ¯ï¼ŒAI ç”Ÿæˆä¸“ä¸šçš„å¤šé¡µé¢ä¸ªäººç½‘ç«™ï¼Œæ”¯æŒå®æ—¶æŸ¥çœ‹ä»£ç å’Œé¢„è§ˆ" />
</svelte:head>

<div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <div class="mb-8">
    <div class="flex items-center space-x-4 mb-6">
      <div
        class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center shadow-medium"
      >
        <span class="text-white text-xl">ğŸŒ</span>
      </div>
      <div>
        <h1 class="text-3xl font-bold text-neutral-800">ä¸ªäººç½‘ç«™ç”Ÿæˆå™¨</h1>
        <p class="text-neutral-600">å¡«å†™è¡¨å•ä¿¡æ¯ï¼ŒAI ç”Ÿæˆä¸“ä¸šçš„å¤šé¡µé¢ä¸ªäººç½‘ç«™ï¼ˆå«è·¯ç”±ç³»ç»Ÿï¼‰</p>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- å·¦ä¾§ï¼šè¾“å…¥åŒºåŸŸ -->
    <div class="space-y-6">
      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <div
        class="bg-white/70 backdrop-blur-sm rounded-2xl p-6 shadow-soft border border-white/20"
      >
        <h3
          class="text-lg font-semibold text-neutral-800 mb-4 flex items-center"
        >
          <span class="w-2 h-2 bg-red-500 rounded-full mr-3"></span>
          åŸºæœ¬ä¿¡æ¯ <span class="text-red-500 ml-1">*</span>
        </h3>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="name" class="block text-sm font-medium text-neutral-700 mb-2">
              å§“å <span class="text-red-500">*</span>
            </label>
            <input
              id="name"
              type="text"
              bind:value={formData.name}
              class="w-full px-4 py-2 border border-neutral-300 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-colors"
              placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰"
            />
          </div>
          <div>
            <label for="profession" class="block text-sm font-medium text-neutral-700 mb-2">
              èŒä¸š <span class="text-red-500">*</span>
            </label>
            <input
              id="profession"
              type="text"
              bind:value={formData.profession}
              class="w-full px-4 py-2 border border-neutral-300 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-colors"
              placeholder="ä¾‹å¦‚ï¼šå…¨æ ˆå¼€å‘å·¥ç¨‹å¸ˆ"
            />
          </div>
        </div>
      </div>

      <!-- æŠ€èƒ½å’Œçˆ±å¥½ -->
      <div
        class="bg-white/70 backdrop-blur-sm rounded-2xl p-6 shadow-soft border border-white/20"
      >
        <h3
          class="text-lg font-semibold text-neutral-800 mb-4 flex items-center"
        >
          <span class="w-2 h-2 bg-blue-500 rounded-full mr-3"></span>
          æŠ€èƒ½å’Œçˆ±å¥½
        </h3>
        <input
          type="text"
          bind:value={formData.skills}
          class="w-full px-4 py-2 border border-neutral-300 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-colors"
          placeholder="ä¾‹å¦‚ï¼šå‰ç«¯å¼€å‘ã€UIè®¾è®¡ã€æ‘„å½±ã€é˜…è¯»"
        />
      </div>

      <!-- èƒŒæ™¯ç»å† -->
      <div
        class="bg-white/70 backdrop-blur-sm rounded-2xl p-6 shadow-soft border border-white/20"
      >
        <h3
          class="text-lg font-semibold text-neutral-800 mb-4 flex items-center"
        >
          <span class="w-2 h-2 bg-blue-500 rounded-full mr-3"></span>
          æ•™è‚²èƒŒæ™¯/å·¥ä½œç»å†
        </h3>
        <textarea
          bind:value={formData.background}
          class="w-full h-32 p-4 border border-neutral-300 rounded-lg text-sm resize-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-colors"
          placeholder="è¯·è¾“å…¥ä½ çš„æ•™è‚²èƒŒæ™¯æˆ–å·¥ä½œç»å†ï¼Œä¾‹å¦‚ï¼š&#10;&#10;â€¢ 2018-2022 æŸæŸå¤§å­¦ è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯&#10;â€¢ 2022-è‡³ä»Š æŸæŸå…¬å¸ é«˜çº§å‰ç«¯å·¥ç¨‹å¸ˆ&#10;â€¢ è´Ÿè´£å…¬å¸æ ¸å¿ƒäº§å“çš„å‰ç«¯æ¶æ„è®¾è®¡..."
        ></textarea>
      </div>

      <!-- è”ç³»æ–¹å¼ -->
      <div
        class="bg-white/70 backdrop-blur-sm rounded-2xl p-6 shadow-soft border border-white/20"
      >
        <h3
          class="text-lg font-semibold text-neutral-800 mb-4 flex items-center"
        >
          <span class="w-2 h-2 bg-blue-500 rounded-full mr-3"></span>
          è”ç³»æ–¹å¼ <span class="text-neutral-500 text-sm font-normal ml-2">(å¯é€‰)</span>
        </h3>
        <div class="flex gap-3">
          <select
            bind:value={formData.contactType}
            class="px-4 py-2 border border-neutral-300 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-colors bg-white"
          >
            <option value="email">ğŸ“§ é‚®ç®±</option>
            <option value="wechat">ğŸ’¬ å¾®ä¿¡</option>
            <option value="github">ğŸ™ GitHub</option>
          </select>
          <input
            type="text"
            bind:value={formData.contactValue}
            class="flex-1 px-4 py-2 border border-neutral-300 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-colors"
            placeholder={formData.contactType === "email" ? "your@email.com" : formData.contactType === "wechat" ? "your-wechat-id" : "github.com/username"}
          />
        </div>
      </div>

      <!-- ç”ŸæˆæŒ‰é’® -->
      <div
        class="bg-white/70 backdrop-blur-sm rounded-2xl p-6 shadow-soft border border-white/20"
      >
        <div class="flex space-x-4">
          <button
            class="flex-1 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 disabled:from-neutral-300 disabled:to-neutral-400 text-white font-medium py-4 px-6 rounded-xl shadow-medium hover:shadow-strong disabled:shadow-none transition-all duration-200 hover:-translate-y-0.5 disabled:translate-y-0 disabled:cursor-not-allowed relative overflow-hidden"
            on:click={generateWebsite}
            disabled={!$apiKeyStore || loading}
          >
            {#if loading && progress > 0}
              <div
                class="absolute inset-0 bg-cyan-400/30 transition-all duration-300 ease-out"
                style="width: {progress}%"
              ></div>
            {/if}
            <span
              class="flex items-center justify-center space-x-2 relative z-10"
            >
              {#if loading}
                <svg
                  class="animate-spin h-5 w-5"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 714 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
                <span>{$statusTip} {progress}%</span>
              {:else}
                <span>ğŸŒ</span>
                <span>ç”Ÿæˆä¸ªäººç½‘ç«™</span>
              {/if}
            </span>
          </button>

          <button
            on:click={resetAll}
            class="px-6 py-4 bg-neutral-100 hover:bg-neutral-200 text-neutral-700 font-medium rounded-xl transition-colors duration-200"
          >
            é‡ç½®
          </button>
        </div>
      </div>

      <!-- éƒ¨ç½²é€‰é¡¹ -->
      {#if hasResult}
        <div
          class="bg-white/70 backdrop-blur-sm rounded-2xl p-6 shadow-soft border border-white/20"
        >
          <h3
            class="text-lg font-semibold text-neutral-800 mb-4 flex items-center"
          >
            <span class="w-2 h-2 bg-green-500 rounded-full mr-3"></span>
            éƒ¨ç½²é€‰é¡¹
          </h3>

          <!-- ä¸‹è½½ HTML -->
          <div class="mb-4">
            <button
              on:click={downloadHTML}
              class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-medium py-3 px-6 rounded-xl shadow-medium hover:shadow-strong transition-all duration-200 hover:-translate-y-0.5"
            >
              <span class="flex items-center justify-center space-x-2">
                <span>â¬‡ï¸</span>
                <span>ä¸‹è½½ HTML æ–‡ä»¶</span>
              </span>
            </button>
            <p class="text-xs text-neutral-500 mt-2 text-center">
              ä¸‹è½½åå¯ä»¥è‡ªå·±æ‰˜ç®¡åˆ°ä»»ä½•é™æ€ç½‘ç«™æœåŠ¡
            </p>
          </div>

          <!-- GitHub Gist éƒ¨ç½² -->
          <div class="pt-4 border-t border-neutral-200">
            <label for="github-token" class="block text-sm font-medium text-neutral-700 mb-2">
              GitHub Tokenï¼ˆç”¨äº Gist æ‰˜ç®¡ï¼‰
            </label>
            <input
              id="github-token"
              type="password"
              bind:value={githubToken}
              class="w-full px-4 py-2 border border-neutral-300 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-colors mb-3"
              placeholder="ghp_xxxxxxxxxxxxxxxx"
            />
            <button
              on:click={deployToGist}
              disabled={!githubToken.trim() || isDeploying}
              class="w-full bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 disabled:from-neutral-300 disabled:to-neutral-400 text-white font-medium py-3 px-6 rounded-xl shadow-medium hover:shadow-strong disabled:shadow-none transition-all duration-200 hover:-translate-y-0.5 disabled:translate-y-0 disabled:cursor-not-allowed"
            >
              <span class="flex items-center justify-center space-x-2">
                {#if isDeploying}
                  <svg
                    class="animate-spin h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                  >
                    <circle
                      class="opacity-25"
                      cx="12"
                      cy="12"
                      r="10"
                      stroke="currentColor"
                      stroke-width="4"
                    ></circle>
                    <path
                      class="opacity-75"
                      fill="currentColor"
                      d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 714 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                    ></path>
                  </svg>
                  <span>éƒ¨ç½²ä¸­...</span>
                {:else}
                  <span>ğŸš€</span>
                  <span>éƒ¨ç½²åˆ° GitHub Gist</span>
                {/if}
              </span>
            </button>

            {#if gistUrl}
              <div class="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                <p class="text-sm text-green-800 mb-2 font-medium">
                  âœ… éƒ¨ç½²æˆåŠŸï¼
                </p>
                <a
                  href={gistUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-sm text-blue-600 hover:text-blue-800 underline break-all"
                >
                  {gistUrl}
                </a>
              </div>
            {/if}

            <p class="text-xs text-neutral-500 mt-2">
              éœ€è¦ GitHub Tokenï¼Ÿ
              <a
                href="https://github.com/settings/tokens/new?scopes=gist"
                target="_blank"
                rel="noopener noreferrer"
                class="text-cyan-600 hover:text-cyan-800 underline"
              >
                ç‚¹å‡»è¿™é‡Œåˆ›å»º
              </a>
              ï¼ˆåªéœ€å‹¾é€‰ gist æƒé™ï¼‰
            </p>
          </div>
        </div>
      {/if}
    </div>

    <!-- å³ä¾§ï¼šé¢„è§ˆåŒºåŸŸ -->
    <div class="space-y-6">
      <div
        class="bg-white/70 backdrop-blur-sm rounded-2xl p-6 shadow-soft border border-white/20 sticky top-6"
      >
        <!-- æ ‡é¢˜å’Œåˆ‡æ¢æŒ‰é’® -->
        <div class="flex items-center justify-between mb-4">
          <h3
            class="text-lg font-semibold text-neutral-800 flex items-center"
          >
            <span class="w-2 h-2 bg-blue-500 rounded-full mr-3"></span>
            {viewMode === "preview" ? "å®æ—¶é¢„è§ˆ" : "ä»£ç è§†å›¾"}
          </h3>
          
          <!-- è§†å›¾åˆ‡æ¢æŒ‰é’® -->
          {#if hasResult || loading}
            <div class="flex bg-neutral-100 rounded-lg p-1">
              <button
                on:click={() => viewMode = "preview"}
                class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors"
                class:bg-white={viewMode === "preview"}
                class:text-cyan-600={viewMode === "preview"}
                class:shadow-sm={viewMode === "preview"}
                class:text-neutral-600={viewMode !== "preview"}
              >
                ğŸ‘ï¸ é¢„è§ˆ
              </button>
              <button
                on:click={() => viewMode = "code"}
                class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors"
                class:bg-white={viewMode === "code"}
                class:text-cyan-600={viewMode === "code"}
                class:shadow-sm={viewMode === "code"}
                class:text-neutral-600={viewMode !== "code"}
              >
                ğŸ’» ä»£ç 
              </button>
            </div>
          {/if}
        </div>

        {#if error}
          <div
            class="bg-red-50 border border-red-200 rounded-lg p-4 text-sm text-red-800"
          >
            <p class="font-medium mb-2">âš ï¸ ç”Ÿæˆå¤±è´¥</p>
            <p class="whitespace-pre-wrap">{error}</p>
          </div>
        {:else if viewMode === "preview"}
          <!-- é¢„è§ˆè§†å›¾ -->
          {#if htmlCode || loading}
            <div class="relative" bind:this={previewContainer}>
              {#if htmlCode}
                <iframe
                  title="ç½‘ç«™é¢„è§ˆ"
                  srcdoc={htmlCode}
                  class="w-full h-[600px] border border-neutral-200 rounded-lg bg-white"
                  sandbox="allow-scripts"
                ></iframe>
                <!-- æ“ä½œæŒ‰é’®ç»„ -->
                <div class="absolute top-2 right-2 flex gap-2">
                  <button
                    on:click={openInNewWindow}
                    class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1.5 rounded shadow-md transition-colors flex items-center gap-1"
                    title="åœ¨æ–°çª—å£æ‰“å¼€"
                  >
                    ğŸ”— æ–°çª—å£
                  </button>
                  <button
                    on:click={toggleFullscreen}
                    class="hidden md:flex bg-green-500 hover:bg-green-600 text-white text-xs px-3 py-1.5 rounded shadow-md transition-colors items-center gap-1"
                    title={isFullscreen ? "é€€å‡ºå…¨å±" : "å…¨å±æ˜¾ç¤º"}
                  >
                    {#if isFullscreen}
                      â›¶ é€€å‡º
                    {:else}
                      â›¶ å…¨å±
                    {/if}
                  </button>
                </div>
              {:else if loading}
                <div class="flex flex-col items-center justify-center h-[600px] border border-neutral-200 rounded-lg bg-neutral-50">
                  <svg
                    class="animate-spin h-10 w-10 mb-4 text-cyan-500"
                    fill="none"
                    viewBox="0 0 24 24"
                  >
                    <circle
                      class="opacity-25"
                      cx="12"
                      cy="12"
                      r="10"
                      stroke="currentColor"
                      stroke-width="4"
                    ></circle>
                    <path
                      class="opacity-75"
                      fill="currentColor"
                      d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 714 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                    ></path>
                  </svg>
                  <p class="text-neutral-500">æ­£åœ¨ç”Ÿæˆä½ çš„ä¸ªäººç½‘ç«™...</p>
                  <p class="text-xs text-neutral-400 mt-2">å¯ä»¥åˆ‡æ¢åˆ°"ä»£ç è§†å›¾"æŸ¥çœ‹ç”Ÿæˆè¿‡ç¨‹</p>
                </div>
              {/if}
            </div>
          {:else}
            <div class="flex flex-col items-center justify-center h-[600px] text-neutral-400">
              <svg
                class="w-16 h-16 mb-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                />
              </svg>
              <p>è¾“å…¥è‡ªæˆ‘ä»‹ç»åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºç”Ÿæˆçš„ç½‘ç«™é¢„è§ˆ</p>
            </div>
          {/if}
        {:else}
          <!-- ä»£ç è§†å›¾ -->
          <div class="relative">
            <pre
              class="w-full h-[600px] overflow-auto bg-neutral-900 text-neutral-100 p-4 rounded-lg text-xs font-mono border border-neutral-700"
            ><code>{result || loading ? (result || "æ­£åœ¨ç”Ÿæˆä»£ç ...") : "ç­‰å¾…ç”Ÿæˆ..."}</code></pre>
            {#if result}
              <button
                on:click={() => {
                  navigator.clipboard.writeText(result);
                  alert("ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
                }}
                class="absolute top-2 right-2 bg-cyan-500 hover:bg-cyan-600 text-white text-xs px-3 py-1.5 rounded transition-colors"
              >
                ğŸ“‹ å¤åˆ¶ä»£ç 
              </button>
            {/if}
          </div>
        {/if}
      </div>
    </div>
  </div>
</div>

<style>
  /* å…¨å±æ—¶çš„æ ·å¼ */
  :global(.relative:fullscreen) {
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }

  :global(.relative:fullscreen iframe) {
    width: 100vw !important;
    height: 100vh !important;
    border: none !important;
    border-radius: 0 !important;
  }

  :global(.relative:fullscreen .absolute) {
    position: fixed !important;
    top: 1rem !important;
    right: 1rem !important;
    z-index: 9999 !important;
  }
</style>

